<!doctype html>
<html lang="tr">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="To-Do">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#111111" />
  <title>todoapp</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" href="./icon-512.png" />
  <link rel="apple-touch-icon" href="./icon-512.png" />
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --nav-height: 60px;
      --frame-termin:#fb7185; --frame-hedef:#60a5fa; --frame-gorev:#34d399;
    }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
    html, body{ height:100%; margin:0; background:var(--bg); color:var(--text); overflow:hidden; }
    #authOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .authBox { width: 100%; max-width: 360px; background: var(--card); border: 1px solid var(--line); border-radius: 20px; padding: 24px; text-align:center; }
    .authBox input { width:100%; padding:12px; margin-bottom:10px; background:#000; border:1px solid var(--line); color:#fff; border-radius:10px; }
    .authBtn { width:100%; padding:12px; background:var(--accent); color:#000; font-weight:bold; border:0; border-radius:10px; cursor:pointer; margin-top:5px; }
    .app-container { height: 100%; display: flex; flex-direction: column; }
    .page-content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 80px; position: relative; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--card); border-top: 1px solid var(--line); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--muted); background: none; border: none; font-size: 10px; cursor: pointer; width: 20%; }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 20px; line-height: 1; }
    h2 { margin: 0 0 16px 0; font-size: 22px; font-weight: 700; }
    .btn { background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn-primary { background:var(--accent); color:#000; border-color:var(--accent); font-weight:600; }
    .fab { position: fixed; bottom: 75px; right: 20px; width: 56px; height: 56px; background: var(--accent); color: #000; border-radius: 50%; display: grid; place-items: center; font-size: 30px; box-shadow: 0 10px 30px rgba(0,0,0,.35); z-index: 90; border:none; cursor: pointer; }
    .daily-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .date-display { text-align: center; display: flex; flex-direction: column; align-items: center; }
    .date-big { font-size: 18px; font-weight: bold; }
    .date-small { font-size: 13px; color: var(--muted); }
    .arrow-btn { background: transparent; border: none; color: var(--text); font-size: 24px; padding: 10px; cursor: pointer; }
    .today-btn { background: none; border: 1px solid var(--line); color: var(--accent); font-size: 11px; padding: 4px 10px; border-radius: 20px; margin-bottom: 20px; cursor: pointer; display: inline-block; }
    .task-card { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; align-items: flex-start; gap: 12px; border: 1px solid var(--line); border-left-width: 4px; transition: all 0.2s ease; }
    .task-card.done { opacity: 0.5; }
    .check-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--muted); flex-shrink: 0; display: grid; place-items: center; cursor: pointer; margin-top: 2px; }
    .check-circle.checked { background: var(--accent); border-color: var(--accent); color: #000; font-weight: bold; font-size: 14px; }
    .task-content { flex:1; cursor: pointer; min-width: 0; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 15px; }
    .cal-cell { aspect-ratio: 1; background: var(--card); border-radius: 8px; border: 1px solid var(--line); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
    .cal-cell.today { border-color: var(--accent); color: var(--accent); font-weight: bold; }
    .cal-cell.active-day { background: var(--text); color: var(--bg); border-color: var(--text); font-weight: bold; }
    .dots { display: flex; gap: 2px; margin-top: 2px; }
    .dot { width: 4px; height: 4px; border-radius: 50%; }

    .habit-row { display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 14px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--line); }
    .habit-left { display: flex; align-items: center; gap: 12px; flex:1; cursor:pointer; }
    .streak-badge { font-size:12px; background:#2a2a2f; padding:4px 8px; border-radius:8px; color:#fbbf24; margin-left:auto; display:flex; align-items:center; gap:4px; border: 1px solid #444;}
    .tag-row { display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--card); border-radius: 10px; margin-bottom: 6px; font-size: 13px; }
    .tag-ctrl-btn { background: #000; color: #fff; border: 1px solid #333; width: 24px; height: 24px; border-radius: 6px; display: grid; place-items: center; cursor: pointer; font-size: 10px; }
    .color-dot { width: 14px; height: 14px; border-radius: 4px; border: 1px solid var(--line); flex-shrink: 0; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: flex-end; }
    .modal-sheet { width: 100%; background: #1c1c1e; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s ease; display:flex; flex-direction:column; max-height:90vh; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--line); color: #fff; border-radius: 10px; margin-bottom: 10px; }
    .modal-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .modal-select { flex: 1; padding: 10px; background: #000; border: 1px solid var(--line); color: #fff; border-radius: 8px; }

    .habit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .habit-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top:15px; }
    .habit-cal-cell { aspect-ratio:1; background:#000; border-radius:6px; border:1px solid #333; display:flex; align-items:center; justify-content:center; font-size:12px; color:#555; }
    .habit-cal-cell.done { background:var(--accent); color:#000; font-weight:bold; border-color:var(--accent); }

    #dialogOverlay { display:none; }

    @media (min-width: 768px) {
      body { background: #050505; }
      .app-container { max-width: 700px; margin: 0 auto; background: var(--bg); border-left: 1px solid var(--line); border-right: 1px solid var(--line); min-height: 100vh; }
      .bottom-nav { max-width: 700px; left: 50%; transform: translateX(-50%); border-right: 1px solid var(--line); border-left: 1px solid var(--line); }
      .fab { right: auto; left: 50%; margin-left: 270px; }
      .modal-sheet { max-width: 700px; margin: 0 auto; left: 0; right: 0; }
    }
  </style>
</head>
<body>

  <div id="authOverlay">
    <div class="authBox">
      <h2>todoapp</h2>
      <p style="color:#aaa; font-size:13px;">Devam etmek i√ßin giri≈ü yap</p>
      <input type="email" id="authEmail" placeholder="E-posta" />
      <input type="password" id="authPass" placeholder="≈ûifre" />
      <div id="authError" style="color:#fb7185; font-size:12px; height:20px;"></div>
      <button id="btnLogin" class="authBtn">Giri≈ü Yap</button>
      <button id="btnSignup" class="btn" style="width:100%; margin-top:10px; border:none; background:transparent; color:#aaa;">Kayƒ±t Ol</button>
    </div>
  </div>

  <div id="dialogOverlay" class="modal-overlay" style="z-index: 300; align-items:center; justify-content:center;">
    <div class="authBox" style="background:#1c1c1e; border:1px solid var(--line); width:90%; max-width:320px;">
      <h3 id="dialogTitle" style="margin-top:0;">Ba≈ülƒ±k</h3>
      <p id="dialogMsg" style="color:var(--muted); font-size:14px; margin-bottom:15px;"></p>
      <input type="text" id="dialogInput" class="modal-input" style="display:none;" />
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button id="dialogCancel" class="btn" style="flex:1;">ƒ∞ptal</button>
        <button id="dialogOk" class="btn btn-primary" style="flex:1;">Tamam</button>
      </div>
    </div>
  </div>

  <div id="appWrap" class="app-container" style="display:none;" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
    <div id="pageContainer" class="page-content"></div>
    <button id="fabBtn" class="fab">+</button>
    <nav class="bottom-nav">
      <button class="nav-item active" onclick="router('daily')"><span class="nav-icon">üìÖ</span><span>G√ºnl√ºk</span></button>
      <button class="nav-item" onclick="router('calendar')"><span class="nav-icon">üóìÔ∏è</span><span>Takvim</span></button>
      <button class="nav-item" onclick="router('inbox')"><span class="nav-icon">üì•</span><span>Inbox</span></button>
      <button class="nav-item" onclick="router('habits')"><span class="nav-icon">‚úÖ</span><span>Habits</span></button>
      <button class="nav-item" onclick="router('settings')"><span class="nav-icon">‚öôÔ∏è</span><span>Ayarlar</span></button>
    </nav>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-sheet">
      <h3 id="modalTitle" style="margin-top:0;">Yeni Ekle</h3>

      <input type="text" id="mText" class="modal-input" placeholder="Ba≈ülƒ±k..." />

      <div class="modal-row">
        <input type="time" id="mTime" class="modal-input" style="flex:1;" />
        <select id="mType" class="modal-select">
          <option value="gorev">G√∂rev</option>
          <option value="termin">Termin</option>
          <option value="hedef">Hedef</option>
        </select>
      </div>

      <!-- ‚úÖ EKLENDƒ∞: Tarih alanƒ± -->
      <div class="modal-row">
        <input type="date" id="mDate" class="modal-input" style="flex:1;" />
      </div>

      <select id="mTag" class="modal-select" style="width:100%; margin-bottom:10px;"></select>
      <textarea id="mNote" class="modal-input" placeholder="Notlar..." rows="3" style="resize:none; margin-bottom:15px; font-family:inherit;"></textarea>

      <div style="display:flex; gap:10px;">
        <button id="modalClose" class="btn" style="flex:1;">ƒ∞ptal</button>
        <button id="modalSave" class="btn btn-primary" style="flex:1;">Kaydet</button>
      </div>
    </div>
  </div>

  <div id="habitModal" class="modal-overlay">
    <div class="modal-sheet" style="max-height: 90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="flex:1"></div>
        <button onclick="document.getElementById('habitModal').style.display='none'" style="background:none; border:none; color:#555; font-size:20px;">‚úï</button>
      </div>
      <div class="habit-header">
        <button class="arrow-btn" onclick="changeHabitMonth(-1)">‚ùÆ</button>
        <div style="text-align:center;">
            <h3 id="habitDetailTitle" style="margin:0;">Alƒ±≈ükanlƒ±k</h3>
            <div id="habitDetailMonth" style="font-size:12px; color:var(--muted); margin-top:2px;"></div>
        </div>
        <button class="arrow-btn" onclick="changeHabitMonth(1)">‚ùØ</button>
      </div>
      <div id="habitDetailStats" style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--accent);"></div>
      <div id="habitCalendar" class="habit-cal-grid"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://czuprhvrnlqpipcytvwx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM";
    let _supabase = null;
    if(SUPABASE_URL && SUPABASE_KEY) _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let db = { days:{}, inbox:[], tags:[], habits:[], habitHistory:{} };
    let currentUser = null;
    let currentPage = 'daily';
    let selectedDate = new Date();
    let currentModalDest = 'day';
    let editState = null;
    let touchStartX = 0; let touchEndX = 0;
    let selectedHabitId = null; let selectedHabitMonth = new Date();

    const appWrap = document.getElementById('appWrap');
    const authOverlay = document.getElementById('authOverlay');
    const pageContainer = document.getElementById('pageContainer');

    async function initApp(){
      const { data: { session } } = await _supabase.auth.getSession();
      if(session) handleSession(session);
      else authOverlay.style.display = 'flex';
    }

    async function handleSession(session){
      currentUser = session.user;
      authOverlay.style.display = 'none';
      appWrap.style.display = 'flex';
      await loadRemoteDB();
      if(!db.tags || db.tags.length===0) db.tags = [{name:'genel', color:'#7dd3fc'}];
      _supabase.channel('public:user_data').on('postgres_changes', { event: '*', schema: 'public', table: 'user_data' }, payload => {
          if(payload.new && payload.new.id === currentUser.id){
            db = payload.new.content;
            if(!db.habitHistory) db.habitHistory = {};
            renderCurrentPage();
          }
      }).subscribe();
      router('daily');
    }

    async function loadRemoteDB(){
      const local = localStorage.getItem('mini_todo_v1');
      if(local) try { db = JSON.parse(local); } catch(e){}
      const { data } = await _supabase.from('user_data').select('content').eq('id', currentUser.id).single();
      if(data && data.content) {
        db = data.content;
        if(!db.habitHistory) db.habitHistory = {};
        localStorage.setItem('mini_todo_v1', JSON.stringify(db));
      } else saveDB();
    }

    function saveDB(){
      localStorage.setItem('mini_todo_v1', JSON.stringify(db));
      if(currentUser) _supabase.from('user_data').upsert({ id: currentUser.id, content: db, updated_at: new Date() }).then();
    }

    function dayKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function sortTasks(tasks) {
      if(!tasks) return [];
      const typeWeight = { 'termin': 1, 'hedef': 2, 'gorev': 3 };
      return [...tasks].sort((a, b) => {
        const tA = typeWeight[a.type] || 3;
        const tB = typeWeight[b.type] || 3;
        if(tA !== tB) return tA - tB;
        const getMins = (timeStr) => {
            if(!timeStr) return 9999;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };
        const timeDiff = getMins(a.time) - getMins(b.time);
        if(timeDiff !== 0) return timeDiff;
        let tagA = db.tags.findIndex(t => t.name === a.tag);
        let tagB = db.tags.findIndex(t => t.name === b.tag);
        return (tagA === -1 ? 999 : tagA) - (tagB === -1 ? 999 : tagB);
      });
    }

    function router(page){
      currentPage = page;
      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
      const map = {'daily':0, 'calendar':1, 'inbox':2, 'habits':3, 'settings':4};
      document.querySelectorAll('.nav-item')[map[page]].classList.add('active');
      document.getElementById('fabBtn').style.display = ['daily', 'calendar', 'inbox'].includes(page) ? 'grid' : 'none';
      renderCurrentPage();
    }

    function renderCurrentPage(){
      pageContainer.innerHTML = '';
      if(currentPage === 'daily') renderDaily();
      else if(currentPage === 'calendar') renderCalendar();
      else if(currentPage === 'inbox') renderInbox();
      else if(currentPage === 'habits') renderHabits();
      else if(currentPage === 'settings') renderSettings();
    }

    // --- DAILY PAGE ---
    function renderDaily(){
      const k = dayKey(selectedDate);
      const isToday = dayKey(new Date()) === k;
      const items = sortTasks(db.days[k] || []);

      const header = document.createElement('div');
      header.className = 'daily-header';
      header.innerHTML = `
        <button class="arrow-btn" onclick="changeDay(-1)">‚ùÆ</button>
        <div class="date-display">
          <div class="date-big">${selectedDate.toLocaleDateString('tr-TR', {day:'numeric', month:'long'})}</div>
          <div class="date-small">${selectedDate.toLocaleDateString('tr-TR', {weekday:'long', year:'numeric'})}</div>
        </div>
        <button class="arrow-btn" onclick="changeDay(1)">‚ùØ</button>
      `;
      pageContainer.appendChild(header);

      if(!isToday) {
        const div = document.createElement('div'); div.style.textAlign = 'center';
        div.innerHTML = `<button class="today-btn" onclick="goToToday()">Bug√ºn'e D√∂n ‚Ü∫</button>`;
        pageContainer.appendChild(div);
      }

      if(items.length === 0) pageContainer.innerHTML += `<div style="text-align:center; color:var(--muted); margin-top:30px;">Plan yok.</div>`;
      else items.forEach(item => pageContainer.appendChild(createTaskCard(item, 'day', k)));
    }

    function changeDay(delta){ selectedDate.setDate(selectedDate.getDate() + delta); renderCurrentPage(); }
    function goToToday(){ selectedDate = new Date(); renderCurrentPage(); }

    // --- CALENDAR PAGE (FIXED) ---
    function renderCalendar(){
      const year = selectedDate.getFullYear();
      const month = selectedDate.getMonth();

      const firstDayOfMonth = new Date(year, month, 1);
      let startDay = firstDayOfMonth.getDay();
      startDay = (startDay === 0) ? 6 : startDay - 1;
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const header = document.createElement('div');
      header.className = 'daily-header';
      header.innerHTML = `
        <button class="arrow-btn" onclick="changeMonth(-1)">‚ùÆ</button>
        <h2 style="margin:0">${firstDayOfMonth.toLocaleDateString('tr-TR', {month:'long', year:'numeric'})}</h2>
        <button class="arrow-btn" onclick="changeMonth(1)">‚ùØ</button>
      `;
      pageContainer.appendChild(header);

      const grid = document.createElement('div'); grid.className = 'calendar-grid';
      ['Pt','Sa','√áa','Pe','Cu','Ct','Pa'].forEach(d => grid.innerHTML += `<div style="text-align:center; font-size:12px; color:var(--muted);">${d}</div>`);

      for(let i=0; i<startDay; i++) grid.innerHTML += `<div></div>`;

      for(let d=1; d<=daysInMonth; d++){
        const curr = new Date(year, month, d);
        const currK = dayKey(curr);
        const dayItems = db.days[currK] || [];
        let dotsHtml = '';
        if(dayItems.length > 0) {
          if(dayItems.some(x => x.type === 'termin' && !x.done)) dotsHtml += `<span class="dot" style="background:var(--frame-termin)"></span>`;
          if(dayItems.some(x => x.type === 'hedef' && !x.done)) dotsHtml += `<span class="dot" style="background:var(--frame-hedef)"></span>`;
          if(!dotsHtml && dayItems.some(x => !x.done)) dotsHtml += `<span class="dot" style="background:var(--muted)"></span>`;
        }
        const isToday = currK === dayKey(new Date());
        const isSel = currK === dayKey(selectedDate);
        const cell = document.createElement('div');
        cell.className = `cal-cell ${isToday ? 'today' : ''} ${isSel ? 'active-day' : ''}`;
        cell.innerHTML = `<div>${d}</div><div class="dots">${dotsHtml}</div>`;
        cell.onclick = () => { selectedDate = new Date(year, month, d); renderCurrentPage(); };
        grid.appendChild(cell);
      }
      pageContainer.appendChild(grid);

      const selKey = dayKey(selectedDate);
      const selItems = sortTasks((db.days[selKey] || []).filter(x => ['termin','hedef'].includes(x.type)));
      const bottom = document.createElement('div');
      bottom.innerHTML = `<div style="margin-top:20px; border-top:1px solid var(--line); padding-top:10px; color:var(--muted); font-size:13px;">${selectedDate.toLocaleDateString('tr-TR')} - √ñnemli Kayƒ±tlar</div>`;
      if(selItems.length===0) bottom.innerHTML += `<div style="color:#555; font-size:12px; margin-top:5px;">Kayƒ±t yok.</div>`;
      else selItems.forEach(item => bottom.appendChild(createTaskCard(item, 'day', selKey)));
      pageContainer.appendChild(bottom);
    }

    function changeMonth(delta){
      selectedDate.setDate(1);
      selectedDate.setMonth(selectedDate.getMonth() + delta);
      renderCurrentPage();
    }

    // --- INBOX PAGE ---
    function renderInbox(){
      pageContainer.innerHTML = `<h2>Brain Dump</h2><div style="color:var(--muted); margin-bottom:15px; font-size:13px;">Aklƒ±ndakileri buraya bo≈üalt.</div>`;
      const items = sortTasks(db.inbox || []);
      if(items.length===0) pageContainer.innerHTML += `<div style="color:#555">Inbox bo≈ü.</div>`;
      else items.forEach(item => pageContainer.appendChild(createTaskCard(item, 'inbox', null)));
    }

    // --- HABITS PAGE ---
    function renderHabits(){
      const head = document.createElement('div');
      head.style.cssText = 'display:flex; justify-content:space-between; align-items:center;';
      head.innerHTML = `<h2>Alƒ±≈ükanlƒ±klar</h2><button class="btn" onclick="addNewHabit()">+ Ekle</button>`;
      pageContainer.appendChild(head);
      const todayK = dayKey(new Date());
      (db.habits || []).forEach(h => {
        const hist = db.habitHistory[h.id] || [];
        const isDone = hist.includes(todayK);
        const streak = calculateStreak(hist);
        const div = document.createElement('div');
        div.className = 'habit-row';
        div.innerHTML = `
          <div class="habit-left" onclick="openHabitDetail('${h.id}')">
            <div class="check-circle ${isDone ? 'checked' : ''}" style="margin-right:10px;">‚úì</div>
            <div style="${isDone ? 'opacity:0.5' : ''}">${h.name}</div>
            ${streak > 0 ? `<div class="streak-badge">üî• ${streak}</div>` : ''}
          </div>
          <button style="background:none; border:none; color:#555;" onclick="deleteHabit('${h.id}')">üóë</button>
        `;
        div.querySelector('.check-circle').onclick = (e) => { e.stopPropagation(); toggleHabit(h.id); };
        pageContainer.appendChild(div);
      });
    }

    function toggleHabit(id){
      const tk = dayKey(new Date());
      if(!db.habitHistory[id]) db.habitHistory[id] = [];
      if(db.habitHistory[id].includes(tk)) db.habitHistory[id] = db.habitHistory[id].filter(x => x !== tk);
      else db.habitHistory[id].push(tk);
      saveDB(); renderCurrentPage();
    }

    function calculateStreak(history){
      if(!history || history.length === 0) return 0;
      const sorted = [...history].sort().reverse();
      let streak = 0; let check = new Date();
      if(sorted.includes(dayKey(check))) { streak = 1; check.setDate(check.getDate() - 1); }
      else { check.setDate(check.getDate() - 1); if(!sorted.includes(dayKey(check))) return 0; }
      while(sorted.includes(dayKey(check))) { streak++; check.setDate(check.getDate() - 1); }
      return streak;
    }

    function openHabitDetail(id){
      selectedHabitId = id; selectedHabitMonth = new Date();
      renderHabitDetailModal();
      document.getElementById('habitModal').style.display = 'flex';
    }

    function changeHabitMonth(delta){
      selectedHabitMonth.setDate(1);
      selectedHabitMonth.setMonth(selectedHabitMonth.getMonth() + delta);
      renderHabitDetailModal();
    }

    function renderHabitDetailModal(){
      const h = db.habits.find(x => x.id === selectedHabitId);
      if(!h) return;
      const hist = db.habitHistory[selectedHabitId] || [];
      document.getElementById('habitDetailTitle').textContent = h.name;
      document.getElementById('habitDetailMonth').textContent = selectedHabitMonth.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
      document.getElementById('habitDetailStats').textContent = `üî• Seri: ${calculateStreak(hist)} G√ºn`;

      const grid = document.getElementById('habitCalendar');
      grid.innerHTML = '';
      ['Pt','Sa','√áa','Pe','Cu','Ct','Pa'].forEach(d => grid.innerHTML += `<div style="text-align:center; font-size:10px; color:var(--muted);">${d}</div>`);

      const y = selectedHabitMonth.getFullYear(), m = selectedHabitMonth.getMonth();
      let start = new Date(y, m, 1).getDay(); start = (start === 0) ? 6 : start - 1;
      const days = new Date(y, m+1, 0).getDate();
      for(let i=0; i<start; i++) grid.innerHTML += `<div></div>`;
      for(let d=1; d<=days; d++){
        const k = dayKey(new Date(y, m, d));
        const done = hist.includes(k);
        grid.innerHTML += `<div class="habit-cal-cell ${done ? 'done' : ''}">${d}</div>`;
      }
    }

    // --- SETTINGS PAGE ---
    function renderSettings(){
      pageContainer.innerHTML = `<h2>Ayarlar</h2>`;
      const sDiv = document.createElement('div');
      sDiv.innerHTML = `
        <div style="margin-bottom:20px;">
          <p style="font-size:13px; color:var(--muted);">Etiket Y√∂netimi</p>
          <div style="display:flex; gap:8px; margin-bottom:12px;">
            <input type="text" id="newTagName" placeholder="Tag adƒ±" style="flex:1; padding:8px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;">
            <input type="color" id="newTagColor" value="#7dd3fc" style="width:40px; height:36px; background:none; border:none;">
            <button class="btn btn-primary" onclick="addTag()">Ekle</button>
          </div>
          <div id="tagList"></div>
        </div>
        <button class="btn" style="width:100%; border-color:#fb7185; color:#fb7185;" onclick="logoutApp()">√áƒ±kƒ±≈ü Yap</button>
      `;
      pageContainer.appendChild(sDiv);
      const tList = document.getElementById('tagList');
      db.tags.forEach((t, i) => {
        const div = document.createElement('div'); div.className = 'tag-row';
        div.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:2px;">
            <div class="tag-ctrl-btn" onclick="moveTag(${i},-1)">‚ñ≤</div>
            <div class="tag-ctrl-btn" onclick="moveTag(${i},1)">‚ñº</div>
          </div>
          <div class="color-dot" style="background:${t.color}"></div>
          <div style="flex:1">${t.name}</div>
          <button style="background:none; border:none; color:#555;" onclick="removeTag('${t.name}')">üóë</button>
        `;
        tList.appendChild(div);
      });
    }

    function addTag(){
      const n = document.getElementById('newTagName').value.trim();
      const c = document.getElementById('newTagColor').value;
      if(n){ db.tags.push({name:n, color:c}); saveDB(); renderSettings(); }
    }
    function moveTag(index, dir){
      if(dir === -1 && index > 0 || dir === 1 && index < db.tags.length - 1){
        const temp = db.tags[index]; db.tags[index] = db.tags[index+dir]; db.tags[index+dir] = temp;
        saveDB(); renderSettings();
      }
    }
    function removeTag(name){ customConfirm("Sil", `"${name}" silinsin mi?`, () => { db.tags = db.tags.filter(t=>t.name!==name); saveDB(); renderSettings(); }); }

    // --- HELPERS & MODALS ---

    // ‚úÖ EKLENDƒ∞: hƒ±zlƒ± ta≈üƒ±ma (prompt ile)
    function quickMoveTask(id, source, key){
      const currentKey = (source === 'inbox') ? '' : key;
      const def = currentKey || dayKey(new Date());
      const picked = window.prompt("Hangi g√ºne ta≈üƒ±nsƒ±n? (YYYY-MM-DD)", def);
      if(!picked) return;

      const re = /^\d{4}-\d{2}-\d{2}$/;
      if(!re.test(picked)) {
        customConfirm("Hata", "Format YYYY-MM-DD olmalƒ±.", () => {});
        return;
      }

      if(source === 'inbox'){
        const item = (db.inbox || []).find(x => x.id === id);
        if(!item) return;
        db.inbox = db.inbox.filter(x => x.id !== id);
        db.days[picked] = db.days[picked] || [];
        db.days[picked].push(item);
      } else {
        const item = (db.days[key] || []).find(x => x.id === id);
        if(!item) return;

        db.days[key] = db.days[key].filter(x => x.id !== id);
        if(db.days[key].length === 0) delete db.days[key];

        db.days[picked] = db.days[picked] || [];
        db.days[picked].push(item);

        selectedDate = new Date(picked);
      }

      saveDB(); renderCurrentPage();
    }

    function createTaskCard(item, source, key){
      const el = document.createElement('div');
      el.className = `task-card ${item.done ? 'done' : ''}`;
      const typeCol = item.type === 'termin' ? 'var(--frame-termin)' : (item.type === 'hedef' ? 'var(--frame-hedef)' : 'var(--frame-gorev)');
      const tag = db.tags.find(t => t.name === item.tag);
      const tagCol = tag ? tag.color : '#333';
      el.style.borderLeftColor = typeCol;
      el.style.background = `linear-gradient(90deg, ${tagCol}15 0%, var(--card) 100%)`;
      el.innerHTML = `
        <div class="check-circle ${item.done ? 'checked' : ''}">‚úì</div>

        <div class="task-content" onclick="openEditTask('${item.id}', '${source}', '${key}')">
          <div style="font-size:14px;">${item.text} ${item.notes ? '<span style="opacity:0.5; font-size:10px;"> üìù</span>' : ''}</div>
          <div style="display:flex; gap:8px; margin-top:4px; font-size:11px; color:var(--muted);">
            ${item.time ? `<span>‚è∞ ${item.time}</span>` : ''}
            ${item.tag ? `<span style="color:${tagCol}; border:1px solid ${tagCol}44; padding:0 4px; border-radius:4px;">${item.tag}</span>` : ''}
          </div>
        </div>

        <!-- ‚úÖ EKLENDƒ∞: hƒ±zlƒ± ta≈üƒ± -->
        <button style="background:none; border:none; color:#555;" onclick="quickMoveTask('${item.id}', '${source}', '${key}')">üìÖ</button>

        <button style="background:none; border:none; color:#555;" onclick="deleteTask('${item.id}', '${source}', '${key}')">‚úï</button>
      `;
      el.querySelector('.check-circle').onclick = (e) => { e.stopPropagation(); toggleTask(item.id, source, key); };
      return el;
    }

    function toggleTask(id, source, key){
      let list = source === 'inbox' ? db.inbox : db.days[key];
      let item = list.find(x => x.id === id);
      if(item) item.done = !item.done;
      saveDB(); renderCurrentPage();
    }

    function deleteTask(id, source, key){
      customConfirm("Sil", "Emin misin?", () => {
        if(source === 'inbox') db.inbox = db.inbox.filter(x => x.id !== id);
        else { db.days[key] = db.days[key].filter(x => x.id !== id); if(db.days[key].length === 0) delete db.days[key]; }
        saveDB(); renderCurrentPage();
      });
    }

    // Modal logic
    const fab = document.getElementById('fabBtn'), modal = document.getElementById('modalOverlay');

    fab.onclick = () => {
      editState = null;
      currentModalDest = currentPage === 'inbox' ? 'inbox' : 'day';
      document.getElementById('modalTitle').textContent = "Yeni Ekle";
      document.getElementById('mText').value = '';
      document.getElementById('mTime').value = '';
      document.getElementById('mNote').value = '';
      document.getElementById('mType').value = 'gorev';

      // ‚úÖ EKLENDƒ∞: yeni eklemede default tarih
      document.getElementById('mDate').value = (currentPage === 'inbox') ? '' : dayKey(selectedDate);

      fillTagSelect();
      modal.style.display = 'flex';
      document.getElementById('mText').focus();
    };

    document.getElementById('modalClose').onclick = () => modal.style.display = 'none';

    function fillTagSelect(){
      const s = document.getElementById('mTag'); s.innerHTML = '<option value="">Etiket Yok</option>';
      db.tags.forEach(t => s.innerHTML += `<option value="${t.name}">${t.name}</option>`);
    }

    function openEditTask(id, source, key){
      editState = {id, source, key};
      const list = source === 'inbox' ? db.inbox : db.days[key];
      const item = list.find(x => x.id === id);

      document.getElementById('modalTitle').textContent = "D√ºzenle";
      document.getElementById('mText').value = item.text;
      document.getElementById('mTime').value = item.time || '';
      document.getElementById('mType').value = item.type || 'gorev';
      document.getElementById('mNote').value = item.notes || '';

      // ‚úÖ EKLENDƒ∞: editte tarih alanƒ±nƒ± doldur
      document.getElementById('mDate').value = (source === 'inbox') ? '' : (key || dayKey(selectedDate));

      fillTagSelect();
      document.getElementById('mTag').value = item.tag || '';
      modal.style.display = 'flex';
    }

    // ‚úÖ G√úN DEƒûƒ∞≈ûTƒ∞RME / TA≈ûIMA MANTIƒûI
    document.getElementById('modalSave').onclick = () => {
      const text = document.getElementById('mText').value.trim();
      if(!text) return;

      const newDateKey = (document.getElementById('mDate').value || '').trim();

      const data = {
        text,
        time: document.getElementById('mTime').value,
        type: document.getElementById('mType').value,
        tag: document.getElementById('mTag').value,
        notes: document.getElementById('mNote').value
      };

      if(editState){
        // Kaynak listeyi bul
        let oldList = editState.source === 'inbox' ? db.inbox : db.days[editState.key];
        let item = oldList.find(x => x.id === editState.id);
        if(!item) return;

        // Inbox -> belirli g√ºne ta≈üƒ±
        if(editState.source === 'inbox' && newDateKey){
          db.inbox = db.inbox.filter(x => x.id !== editState.id);
          db.days[newDateKey] = db.days[newDateKey] || [];
          Object.assign(item, data);
          db.days[newDateKey].push(item);
        }
        // Day i√ßinde g√ºn deƒüi≈ütiyse ta≈üƒ±
        else if(editState.source !== 'inbox' && newDateKey && newDateKey !== editState.key){
          db.days[editState.key] = db.days[editState.key].filter(x => x.id !== editState.id);
          if(db.days[editState.key].length === 0) delete db.days[editState.key];

          db.days[newDateKey] = db.days[newDateKey] || [];
          Object.assign(item, data);
          db.days[newDateKey].push(item);

          selectedDate = new Date(newDateKey);
        }
        // Sadece update
        else {
          Object.assign(item, data);
        }
      } else {
        const newItem = { id: Date.now().toString(), ...data, done: false };

        // Yeni eklemede: Inbox'tayken tarih se√ßildiyse direkt g√ºne at
        if(currentModalDest === 'inbox'){
          if(newDateKey){
            db.days[newDateKey] = db.days[newDateKey] || [];
            db.days[newDateKey].push(newItem);
          } else {
            db.inbox.push(newItem);
          }
        } else {
          const k = newDateKey || dayKey(selectedDate);
          db.days[k] = db.days[k] || [];
          db.days[k].push(newItem);
        }
      }

      saveDB();
      renderCurrentPage();
      modal.style.display = 'none';
    };

    // Dialog & Swipe
    function customConfirm(t, m, cb){
      document.getElementById('dialogTitle').textContent = t;
      document.getElementById('dialogMsg').textContent = m;
      document.getElementById('dialogMsg').style.display = 'block';
      document.getElementById('dialogInput').style.display = 'none';
      document.getElementById('dialogOk').onclick = () => { cb(); document.getElementById('dialogOverlay').style.display='none'; };
      document.getElementById('dialogOverlay').style.display = 'flex';
    }
    document.getElementById('dialogCancel').onclick = () => document.getElementById('dialogOverlay').style.display='none';

    function handleTouchStart(e){ touchStartX = e.changedTouches[0].screenX; }
    function handleTouchEnd(e){
      touchEndX = e.changedTouches[0].screenX;
      if(currentPage === 'daily'){
        if(touchEndX < touchStartX - 60) changeDay(1);
        if(touchEndX > touchStartX + 60) changeDay(-1);
      }
    }

    // Auth actions
    document.getElementById('btnLogin').onclick = async () => {
      const e = document.getElementById('authEmail').value, p = document.getElementById('authPass').value;
      const { error } = await _supabase.auth.signInWithPassword({ email: e, password: p });
      if(error) document.getElementById('authError').textContent = error.message; else window.location.reload();
    };

    function logoutApp(){
      customConfirm("√áƒ±kƒ±≈ü", "Emin misiniz?", async () => {
        await _supabase.auth.signOut();
        localStorage.clear();
        window.location.reload();
      });
    }

    initApp();
  </script>
</body>
</html>